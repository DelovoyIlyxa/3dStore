<!--upload.html -->
{% extends "base.html" %}

{% block title %}Загрузить 3D-модель{% endblock %}

{% block content %}
<style>
    .upload-steps {
        display: flex;
        margin: 32px 0;
        border-bottom: 1px solid var(--border);
    }

    .step {
        padding: 16px 32px;
        color: var(--text-secondary);
        font-weight: 500;
        position: relative;
    }

    .step.active {
        color: var(--accent);
        font-weight: 600;
    }

    .step.active:after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--accent);
    }

    .step-line {
        flex: 1;
        height: 1px;
        background: var(--border);
        margin: auto 0;
    }

    .form-group {
        margin-bottom: 24px;
    }

    label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
    }

    input,
    textarea,
    select {
        width: 100%;
        padding: 14px;
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text);
        font-size: 16px;
    }

    textarea {
        min-height: 120px;
        resize: vertical;
    }

    .file-drop {
        border: 2px dashed var(--border);
        border-radius: 12px;
        padding: 40px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 24px;
    }

    .file-drop:hover,
    .file-drop.dragover {
        border-color: var(--accent);
        background: rgba(255, 42, 109, 0.05);
    }

    .file-drop i {
        font-size: 48px;
        margin-bottom: 16px;
        color: var(--accent);
    }

    .file-preview {
        display: flex;
        gap: 20px;
        margin-top: 24px;
    }

    .preview-item {
        flex: 1;
        text-align: center;
    }

    .preview-img {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border-radius: 8px;
        margin: 0 auto 12px;
        background: var(--card-bg);
    }

    .preview-name {
        font-size: 14px;
        color: var(--text-secondary);
        word-break: break-all;
    }

    .btn-group {
        display: flex;
        gap: 16px;
        margin-top: 32px;
    }

    @media (max-width: 768px) {
        .btn-group {
            flex-direction: column;
        }
    }
</style>

<div class="upload-steps">
    <div class="step active" id="step1">1. Основное</div>
    <div class="step-line"></div>
    <div class="step" id="step2">2. Файлы</div>
    <div class="step-line"></div>
    <div class="step" id="step3">3. Готово</div>
</div>

<form id="uploadForm" 
      enctype="multipart/form-data"
      data-upload-url="{{ url_for('shop.upload') }}">
    <!-- Шаг 1: Основное -->
    <div class="step-content" id="content1">
        <div class="form-group">
            <label for="title">Название модели *</label>
            <input type="text" id="title" name="title" required placeholder="Например: Архитектурный дом 3D">
        </div>

        <div class="form-group">
            <label for="price">Цена, $ *</label>
            <input type="number" id="price" name="price" step="0.01" min="0.99" required placeholder="9.99">
        </div>

        <div class="form-group">
            <label for="description">Описание</label>
            <textarea id="description" name="description"
                placeholder="Расскажите о модели: полигоны, материалы, особенности..."></textarea>
        </div>

        <div class="btn-group">
            <button type="button" class="btn" onclick="nextStep(1)">Далее →</button>
        </div>
    </div>

    <!-- Шаг 2: Файлы -->
    <div class="step-content" id="content2" style="display:none;">
        <h2 style="margin-bottom:24px;">Загрузите файлы</h2>

        <div class="form-group">
            <label>3D-модель (.glb, .obj, .fbx) *</label>
            <div class="file-drop" id="modelDrop">
                <i class="fas fa-cube"></i>
                <p>Перетащите файл сюда или кликните</p>
                <p style="font-size:14px; color:var(--text-secondary);">Поддерживаются: .glb, .obj, .fbx (до 100 МБ)</p>
                <input type="file" id="modelFile" name="file" accept=".glb,.obj,.fbx" style="display:none;" required>
            </div>
        </div>

        <div class="form-group">
            <label>Превью (изображение)</label>
            <div class="file-drop" id="previewDrop">
                <i class="fas fa-image"></i>
                <p>Превью для карточки товара</p>
                <p style="font-size:14px; color:var(--text-secondary);">.jpg, .png, .webp</p>
                <input type="file" id="previewFile" name="preview" accept="image/*" style="display:none;">
            </div>
        </div>

        <div class="file-preview" id="filePreview" style="display:none;">
            <div class="preview-item" id="modelPreview"></div>
            <div class="preview-item" id="previewPreview"></div>
        </div>

        <div class="btn-group">
            <button type="button" class="btn btn-outline" onclick="prevStep(2)">← Назад</button>
            <button type="button" class="btn" onclick="nextStep(2)">Далее →</button>
        </div>
    </div>

    <!-- Шаг 3: Подтверждение -->
    <div class="step-content" id="content3" style="display:none;">
        <h2 style="margin-bottom:24px;">Проверьте данные</h2>

        <div style="background:var(--card-bg); border-radius:12px; padding:24px; margin-bottom:24px;">
            <div style="display:flex; gap:20px; margin-bottom:16px;">
                <div id="finalPreview"
                    style="width:120px; height:120px; background:#222; border-radius:8px; display:flex; align-items:center; justify-content:center;">
                    <i class="fas fa-cube" style="font-size:40px; color:#555;"></i>
                </div>
                <div>
                    <h3 id="finalTitle" style="margin:0 0 8px;">Название</h3>
                    <p id="finalPrice" style="color:var(--accent); font-size:20px; margin:0;">$0.00</p>
                </div>
            </div>
            <p id="finalDescription" style="color:var(--text-secondary);">Описание...</p>
        </div>

        <div class="btn-group">
            <button type="button" class="btn btn-outline" onclick="prevStep(3)">← Назад</button>
            <button type="submit" class="btn" id="submitBtn">
                <i class="fas fa-upload"></i> Опубликовать модель
            </button>
        </div>
    </div>
</form>

<script>
    let currentStep = 1;

    function showStep(step) {
        document.querySelectorAll('.step-content').forEach(el => el.style.display = 'none');
        document.getElementById(`content${step}`).style.display = 'block';

        document.querySelectorAll('.step').forEach((el, i) => {
            el.classList.toggle('active', i < step);
        });
        currentStep = step;
    }

    function nextStep(from) {
        // Валидация шага 1
        if (from === 1) {
            const title = document.getElementById('title').value;
            const price = document.getElementById('price').value;
            if (!title || !price) {
                alert('Заполните название и цену');
                return;
            }
        }
        showStep(from + 1);
    }

    function prevStep(from) {
        showStep(from - 1);
    }

    // Drag & Drop
    ['modelDrop', 'previewDrop'].forEach(id => {
        const drop = document.getElementById(id);
        const input = document.getElementById(id === 'modelDrop' ? 'modelFile' : 'previewFile');

        drop.addEventListener('click', () => input.click());
        drop.addEventListener('dragover', e => {
            e.preventDefault();
            drop.classList.add('dragover');
        });
        drop.addEventListener('dragleave', () => drop.classList.remove('dragover'));
        drop.addEventListener('drop', e => {
            e.preventDefault();
            drop.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                input.files = e.dataTransfer.files;
                handleFileSelect(e.dataTransfer.files[0], id);
            }
        });

        input.addEventListener('change', () => {
            if (input.files.length) {
                handleFileSelect(input.files[0], id);
            }
        });
    });

    function handleFileSelect(file, dropId) {
        const isModel = dropId === 'modelDrop';
        const preview = document.getElementById(isModel ? 'modelPreview' : 'previewPreview');
        const final = document.getElementById('finalPreview');

        const reader = new FileReader();
        reader.onload = e => {
            if (isModel && file.name.endsWith('.glb')) {
                // Для GLB показываем 3Dиконку
                preview.innerHTML = `
                <div class="preview-img" style="display:flex; align-items:center; justify-content:center; background:#1a1a1a;">
                    <i class="fas fa-cube" style="font-size:40px; color:#ff2a6d;"></i>
                </div>
                <div class="preview-name">${file.name}</div>
            `;
                final.innerHTML = `<i class="fas fa-cube" style="font-size:40px; color:#ff2a6d;"></i>`;
            } else if (file.type.startsWith('image/')) {
                preview.innerHTML = `
                <img src="${e.target.result}" class="preview-img">
                <div class="preview-name">${file.name}</div>
            `;
                if (!document.getElementById('modelPreview').querySelector('img')) {
                    final.innerHTML = `<img src="${e.target.result}" style="width:100%; height:100%; object-fit:cover; border-radius:8px;">`;
                }
            } else {
                preview.innerHTML = `
                <div class="preview-img" style="display:flex; align-items:center; justify-content:center; background:#1a1a1a;">
                    <i class="fas fa-file" style="font-size:40px; color:#4ecdc4;"></i>
                </div>
                <div class="preview-name">${file.name}</div>
            `;
            }
            document.getElementById('filePreview').style.display = 'flex';
        };

        if (file.type.startsWith('image/')) {
            reader.readAsDataURL(file);
        } else {
            // Для не изображений просто показываем имя
            const fakeEvent = { target: { result: '' } };
            reader.onload(fakeEvent);
        }
    }

    // Обновление финального превью
    document.getElementById('title').addEventListener('input', updateFinal);
    document.getElementById('price').addEventListener('input', updateFinal);
    document.getElementById('description').addEventListener('input', updateFinal);

    function updateFinal() {
        document.getElementById('finalTitle').textContent = document.getElementById('title').value || 'Название';
        document.getElementById('finalPrice').textContent = '$' + (parseFloat(document.getElementById('price').value) || 0).toFixed(2);
        document.getElementById('finalDescription').textContent = document.getElementById('description').value || 'Описание...';
    }

    // Отправка формы
    document.getElementById('uploadForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const formData = new FormData();
        formData.append('title', document.getElementById('title').value);
        formData.append('price', document.getElementById('price').value);
        formData.append('description', document.getElementById('description').value);
        formData.append('file', document.getElementById('modelFile').files[0]);

        const previewFile = document.getElementById('previewFile').files[0];
        if (previewFile) {
            formData.append('preview', previewFile);
        }

        // Анимация кнопки
        const btn = document.getElementById('submitBtn');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Публикация...';
        btn.disabled = true;

        // Отправка (но надо fetch на /shop/upload)
        document.getElementById('uploadForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(this); // ← берём данные из формы автоматически

            // Анимация кнопки
            const btn = document.getElementById('submitBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Публикация...';
            btn.disabled = true;

            try {
                const response = await fetch("{{ url_for('shop.upload') }}", {
                    method: 'POST',
                    body: formData
                });

                if (response.redirected) {
                    window.location.href = response.url;
                } else {
                    const text = await response.text();
                    alert('Ошибка: ' + (text || 'Неизвестная ошибка'));
                    btn.innerHTML = '<i class="fas fa-upload"></i> Опубликовать модель';
                    btn.disabled = false;
                }
            } catch (err) {
                alert('Ошибка сети: ' + err.message);
                btn.innerHTML = '<i class="fas fa-upload"></i> Опубликовать модель';
                btn.disabled = false;
            }
        });
    });
</script>
{% endblock %}